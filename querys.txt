-- CREA Y USA LA BD
DROP DATABASE IF EXISTS banca_estebanquito;
CREATE DATABASE banca_estebanquito;
USE banca_estebanquito;

-- ============= TABLAS =============

-- Usuarios
CREATE TABLE usuarios (
  id VARCHAR(20) NOT NULL PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  contraseña VARCHAR(255) NOT NULL,   -- largo por si usas hash
  tipo_cuenta ENUM('ahorros','corriente') NOT NULL,
  saldo DECIMAL(10,2) NOT NULL DEFAULT 0.00
);

-- Transacciones
-- Nota: se agrega cuenta_destino_id para que las transferencias sean claras.
CREATE TABLE transacciones (
  id INT AUTO_INCREMENT PRIMARY KEY,
  cuenta_origen_id VARCHAR(20) NOT NULL,
  cuenta_destino_id VARCHAR(20) NULL,  -- NULL en deposito/retiro
  tipo_cuenta ENUM('ahorros','corriente') NOT NULL,
  tipo ENUM('transferencia_enviada','transferencia_recibida','deposito','retiro') NOT NULL,
  monto DECIMAL(10,2) NOT NULL,
  fecha DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (cuenta_origen_id) REFERENCES usuarios(id),
  FOREIGN KEY (cuenta_destino_id) REFERENCES usuarios(id)
);

-- Prestamos
CREATE TABLE prestamos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  usuario_id VARCHAR(20) NOT NULL,
  monto_solicitado DECIMAL(10,2) NOT NULL,
  monto_pendiente DECIMAL(10,2) NOT NULL,  -- lo que falta por pagar
  plazo INT NOT NULL,                       -- en meses
  estado ENUM('pendiente','aprobado','rechazado','pagado') DEFAULT 'pendiente',
  fecha_solicitud DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  fecha_aprobacion DATETIME NULL,
  FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);

-- ============= PROCEDIMIENTOS =============

-- Depositar
DELIMITER //
CREATE PROCEDURE hacer_deposito(
  IN p_usuario_id varchar(20),
  IN p_monto DECIMAL(10,2)
)
BEGIN
  IF p_monto <= 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Monto inválido';
  END IF;

  START TRANSACTION;
    UPDATE usuarios SET saldo = saldo + p_monto WHERE id = p_usuario_id;
    INSERT INTO transacciones (cuenta_origen_id, tipo, monto)
    VALUES (p_usuario_id, 'deposito', p_monto);
  COMMIT;
END //
DELIMITER ;

-- Retirar
DELIMITER //
CREATE PROCEDURE hacer_retiro(
  IN p_usuario_id VARCHAR(20),
  IN p_monto DECIMAL(10,2)
)
BEGIN
  DECLARE v_saldo DECIMAL(10,2);

  IF p_monto <= 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Monto inválido';
  END IF;

  SELECT saldo INTO v_saldo FROM usuarios WHERE id = p_usuario_id;

  IF v_saldo IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Usuario no existe';
  END IF;

  IF v_saldo < p_monto THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Saldo insuficiente';
  END IF;

  START TRANSACTION;
    UPDATE usuarios SET saldo = saldo - p_monto WHERE id = p_usuario_id;
    INSERT INTO transacciones (cuenta_origen_id, tipo, monto)
    VALUES (p_usuario_id, 'retiro', p_monto);
  COMMIT;
END //
DELIMITER ;

-- Transferir (registra envío y recepción)
DELIMITER //
CREATE PROCEDURE hacer_transferencia(
  IN p_origen VARCHAR(20),
  IN p_destino VARCHAR(20),
  IN p_monto DECIMAL(10,2)
)
BEGIN
  DECLARE v_saldo DECIMAL(10,2);

  IF p_monto <= 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Monto inválido';
  END IF;

  IF p_origen = p_destino THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'No se puede transferir a la misma cuenta';
  END IF;

  SELECT saldo INTO v_saldo FROM usuarios WHERE id = p_origen;
  IF v_saldo IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cuenta origen no existe';
  END IF;

  IF (SELECT id FROM usuarios WHERE id = p_destino) IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Cuenta destino no existe';
  END IF;

  IF v_saldo < p_monto THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Saldo insuficiente';
  END IF;

  START TRANSACTION;
    UPDATE usuarios SET saldo = saldo - p_monto WHERE id = p_origen;
    UPDATE usuarios SET saldo = saldo + p_monto WHERE id = p_destino;

    INSERT INTO transacciones (cuenta_origen_id, cuenta_destino_id, tipo, monto)
    VALUES (p_origen, p_destino, 'transferencia_enviada', p_monto);

    INSERT INTO transacciones (cuenta_origen_id, cuenta_destino_id, tipo, monto)
    VALUES (p_destino, p_origen, 'transferencia_recibida', p_monto);
  COMMIT;
END //
DELIMITER ;

-- Solicitar préstamo (deja pendiente hasta aprobar)
DELIMITER //
CREATE PROCEDURE solicitar_prestamo(
  IN p_usuario_id VARCHAR(20),
  IN p_monto DECIMAL(10,2),
  IN p_plazo INT
)
BEGIN
  IF p_monto <= 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Monto inválido';
  END IF;

  INSERT INTO prestamos (usuario_id, monto_solicitado, monto_pendiente, plazo, estado)
  VALUES (p_usuario_id, p_monto, p_monto, p_plazo, 'pendiente');
END //
DELIMITER ;

-- Aprobar préstamo (acredita al saldo)
DELIMITER //
CREATE PROCEDURE aprobar_prestamo(
  IN p_prestamo_id INT
)
BEGIN
  DECLARE v_usuario VARCHAR(20);
  DECLARE v_monto DECIMAL(10,2);
  DECLARE v_estado VARCHAR(20);

  SELECT usuario_id, monto_solicitado, estado
  INTO v_usuario, v_monto, v_estado
  FROM prestamos WHERE id = p_prestamo_id;

  IF v_usuario IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Préstamo no existe';
  END IF;

  IF v_estado <> 'pendiente' THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Préstamo ya procesado';
  END IF;

  START TRANSACTION;
    UPDATE prestamos 
      SET estado = 'aprobado', fecha_aprobacion = CURRENT_TIMESTAMP
      WHERE id = p_prestamo_id;

    UPDATE usuarios SET saldo = saldo + v_monto WHERE id = v_usuario;

    INSERT INTO transacciones (cuenta_origen_id, tipo, monto)
    VALUES (v_usuario, 'deposito', v_monto);
  COMMIT;
END //
DELIMITER ;

-- Reporte financiero simple (ingresos, egresos, deudas)
DELIMITER //
CREATE PROCEDURE reporte_financiero(
  IN p_usuario_id VARCHAR(20)
)
BEGIN
  SELECT 
    -- Ingresos: depósitos + transferencias recibidas
    (SELECT IFNULL(SUM(monto),0)
     FROM transacciones
     WHERE cuenta_origen_id = p_usuario_id
       AND tipo IN ('deposito','transferencia_recibida')) AS ingresos,

    -- Egresos: retiros + transferencias enviadas
    (SELECT IFNULL(SUM(monto),0)
     FROM transacciones
     WHERE cuenta_origen_id = p_usuario_id
       AND tipo IN ('retiro','transferencia_enviada')) AS egresos,

    -- Deuda pendiente (solo préstamos aprobados)
    (SELECT IFNULL(SUM(monto_pendiente),0)
     FROM prestamos
     WHERE usuario_id = p_usuario_id AND estado = 'aprobado') AS deudas;
END //
DELIMITER ;
